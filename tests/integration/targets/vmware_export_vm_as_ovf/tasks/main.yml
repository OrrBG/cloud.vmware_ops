---
- name: Create Test VM
  community.vmware.vmware_guest:
    hostname: "{{ export_vm_as_ovf_hostname }}"
    username: "{{ export_vm_as_ovf_username }}"
    password: "{{ export_vm_as_ovf_password }}"
    validate_certs: false
    name: "{{ export_vm_as_ovf_vm_name }}"
    state: poweredoff
    # networks:
    #   - name: "VM Network"
    #     device_type: "vmxnet3"
    #     type: "dhcp"
    disk:
      - size_gb: 5
        type: thin
        datastore: "datastore1"
    # provision_vm_hardware:
    #   memory_mb: 2000
    #   num_cpus: 4
    #   boot_firmware: efi
    #   secure_boot: true
    guest_id: rhel9_64Guest

- name: Test Export VM As OVF
  ansible.builtin.import_role:
    name: cloud.vmware_ops.export_vm_as_ovf

- name: Destroy Test VM
  community.vmware.vmware_guest:
    hostname: "{{ export_vm_as_ovf_hostname }}"
    username: "{{ export_vm_as_ovf_username }}"
    password: "{{ export_vm_as_ovf_password }}"
    validate_certs: false
    name: "{{ export_vm_as_ovf_vm_name }}"
    state: absent

- name: Delete Exported OVF
  ansible.builtin.file:
    state: absent
    file: "{{ export_vm_as_ovf_export_dir }}"
